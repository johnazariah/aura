#!/bin/sh
# Pre-commit hook for Aura repository
# Catches common issues before they reach CI
#
# Install: ./scripts/Install-GitHooks.ps1

set -e

YELLOW='\033[1;33m'
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "Running pre-commit checks..."
echo ""

# Track failures
FAILED=0

# =============================================================================
# 1. Check for secrets/sensitive data in staged files
# =============================================================================
echo "ğŸ” Checking for secrets..."

# Get list of staged files (excluding deleted files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -n "$STAGED_FILES" ]; then
    # Patterns that suggest secrets (case-insensitive)
    SECRET_PATTERNS='(api[_-]?key|apikey|secret[_-]?key|password|passwd|pwd|token|bearer|authorization|private[_-]?key|access[_-]?key|client[_-]?secret)\s*[:=]\s*["\x27][^"\x27]{8,}'
    
    # Check for hardcoded connection strings with passwords
    CONN_STRING_PATTERN='(Password|Pwd)\s*=\s*[^;]{4,}'
    
    # Check for Azure/AWS/GCP patterns
    CLOUD_PATTERNS='(AKIA[0-9A-Z]{16}|sk-[a-zA-Z0-9]{48}|ghp_[a-zA-Z0-9]{36}|xox[baprs]-[0-9]{10,13}-[0-9]{10,13}-[a-zA-Z0-9]{24})'

    for file in $STAGED_FILES; do
        if [ -f "$file" ]; then
            # Skip binary files and certain extensions
            case "$file" in
                *.png|*.jpg|*.jpeg|*.gif|*.ico|*.woff|*.woff2|*.ttf|*.eot|*.pdf|*.zip|*.dll|*.exe)
                    continue
                    ;;
            esac
            
            # Check for secret patterns
            if git show ":$file" 2>/dev/null | grep -iE "$SECRET_PATTERNS" | grep -v "example\|sample\|placeholder\|<your\|TODO\|CHANGEME" > /dev/null 2>&1; then
                echo "${RED}âŒ Potential secret found in: $file${NC}"
                FAILED=1
            fi
            
            # Check for connection strings (but allow localhost/development ones)
            if git show ":$file" 2>/dev/null | grep -iE "$CONN_STRING_PATTERN" | grep -v "localhost\|127.0.0.1\|example\|aura_dev\|postgres:postgres" > /dev/null 2>&1; then
                echo "${RED}âŒ Potential hardcoded password in connection string: $file${NC}"
                FAILED=1
            fi
            
            # Check for cloud provider keys
            if git show ":$file" 2>/dev/null | grep -E "$CLOUD_PATTERNS" > /dev/null 2>&1; then
                echo "${RED}âŒ Potential cloud API key found in: $file${NC}"
                FAILED=1
            fi
        fi
    done
fi

if [ $FAILED -eq 0 ]; then
    echo "${GREEN}âœ… No secrets detected${NC}"
else
    echo ""
    echo "${RED}Secret check failed! Remove sensitive data before committing.${NC}"
    echo "If this is a false positive, use: git commit --no-verify"
    echo ""
    exit 1
fi

# =============================================================================
# 2. Code formatting check
# =============================================================================
echo ""
echo "ğŸ” Checking code formatting..."

dotnet format --verify-no-changes --verbosity minimal 2>&1

if [ $? -ne 0 ]; then
    echo ""
    echo "${RED}âŒ Code formatting check failed!${NC}"
    echo ""
    echo "Run 'dotnet format' to fix formatting issues, then try again."
    echo ""
    exit 1
fi

echo "${GREEN}âœ… Code formatting passed${NC}"

# =============================================================================
# 3. Feature file validation
# =============================================================================
echo ""
echo "ğŸ” Validating feature files..."

if [ -f "scripts/Validate-Features.ps1" ]; then
    # Run PowerShell validation script
    if command -v pwsh > /dev/null 2>&1; then
        pwsh -NoProfile -ExecutionPolicy Bypass -File scripts/Validate-Features.ps1 2>&1
        if [ $? -ne 0 ]; then
            echo ""
            echo "${RED}âŒ Feature validation failed!${NC}"
            echo ""
            exit 1
        fi
        echo "${GREEN}âœ… Feature files valid${NC}"
    else
        echo "${YELLOW}âš ï¸  PowerShell not found, skipping feature validation${NC}"
    fi
else
    echo "${YELLOW}âš ï¸  Validate-Features.ps1 not found, skipping${NC}"
fi

# =============================================================================
# 4. Check for common mistakes
# =============================================================================
echo ""
echo "ğŸ” Checking for common mistakes..."

MISTAKES=0

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        case "$file" in
            *.cs)
                # Check for Console.WriteLine (should use ILogger)
                if git show ":$file" 2>/dev/null | grep -n "Console\.WriteLine\|Console\.Write(" | grep -v "// OK\|//OK\|#if DEBUG" > /dev/null 2>&1; then
                    echo "${YELLOW}âš ï¸  Console.WriteLine found in $file (use ILogger instead)${NC}"
                fi
                
                # Check for TODO/FIXME/HACK comments (warning only)
                if git show ":$file" 2>/dev/null | grep -E "//\s*(TODO|FIXME|HACK|XXX):" > /dev/null 2>&1; then
                    echo "${YELLOW}âš ï¸  TODO/FIXME comment in $file${NC}"
                fi
                ;;
            *.json)
                # Check for valid JSON syntax
                if command -v python3 > /dev/null 2>&1; then
                    if ! git show ":$file" 2>/dev/null | python3 -m json.tool > /dev/null 2>&1; then
                        echo "${RED}âŒ Invalid JSON syntax in: $file${NC}"
                        MISTAKES=1
                    fi
                fi
                ;;
        esac
    fi
done

if [ $MISTAKES -ne 0 ]; then
    echo ""
    echo "${RED}âŒ Fix the above mistakes before committing.${NC}"
    exit 1
fi

echo "${GREEN}âœ… No blocking mistakes found${NC}"

# =============================================================================
# 5. Quick build check (optional - only if explicitly enabled)
# =============================================================================
if [ -n "$AURA_PRECOMMIT_BUILD" ]; then
    echo ""
    echo "ğŸ” Running build check..."
    
    dotnet build --no-restore --verbosity minimal 2>&1
    
    if [ $? -ne 0 ]; then
        echo ""
        echo "${RED}âŒ Build failed!${NC}"
        exit 1
    fi
    
    echo "${GREEN}âœ… Build passed${NC}"
fi

# =============================================================================
# All checks passed
# =============================================================================
echo ""
echo "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo "${GREEN}âœ… All pre-commit checks passed!${NC}"
echo "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

exit 0
