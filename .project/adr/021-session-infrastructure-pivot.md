# ADR-021: Pivot to Development Session Infrastructure

## Status

Proposed

## Date

2026-01-13

## Context

After completing v1.2.0 with all MVP polish features, we evaluated the strategic direction of Aura. Several factors prompted this reassessment:

### Market Changes

1. **GitHub Copilot now supports multiple agent chat windows** — the original gap we aimed to fill
2. **GHCP added skills and custom modes** — lightweight structured workflows built into the platform
3. **MCP (Model Context Protocol)** — emerging standard for context sharing between AI tools

### Usage Patterns

1. **Structured workflows are too rigid** — real development requires conversation and iteration
2. **Plan → Enrich → Execute → Review** — often fails because agents can't get it right in one shot
3. **The builder (us) prefers free-form conversation** — if we don't use structured mode, users won't either

### Original Vision Revisited

The original dream for the Developer module was parallel development with multiple agents working on independent stories simultaneously. We built worktree support for isolation but never completed the story management layer. Previous attempts (Owlet, hve-hack) failed by starting top-down from GitHub integration. This time we have solid bottom-up infrastructure.

### Monorepo Reality

Real projects have dozens of microservices that can genuinely be developed in parallel. Stories touching different services rarely conflict. The parallelism opportunity is real.

## Decision

**Pivot Aura from "structured workflow engine" to "development session infrastructure that extends GitHub Copilot."**

### What Aura Becomes

```
┌─────────────────────────────────────────────────────┐
│                 Aura = Context Layer                │
│   RAG + Code Graph + Story State + Issue Sync       │
└─────────────────────────────────────────────────────┘
                         │
         ┌───────────────┼───────────────┐
         ▼               ▼               ▼
    ┌─────────┐    ┌──────────┐    ┌──────────┐
    │   MCP   │    │ Extension│    │   API    │
    │  Server │    │    UI    │    │  Direct  │
    └────┬────┘    └────┬─────┘    └────┬─────┘
         │              │               │
         ▼              ▼               ▼
   GHCP/Claude    Story Panel      Automation
```

### Core Value Proposition

| Capability | How It Extends GHCP |
|------------|---------------------|
| **MCP Server** | GHCP calls Aura for deep context (RAG, Code Graph) |
| **Worktree per Story** | Parallel sessions without file conflicts |
| **Story Tracking** | Know what's in flight, stale, ready |
| **Issue Sync** | GitHub Issue = source of truth |
| **Cross-Story Awareness** | Detect conflicts before merge |
| **PR Orchestration** | Story → PR with proper linking |

### What GHCP Does (Not Aura)

- Agent execution
- Code editing  
- Tool use (file read/write, terminal)
- Skills & modes
- The conversation itself

### User Flow

```
GitHub Issue
     ↓
   Story ──→ Worktree ──→ GHCP Agent (with Aura MCP context)
     ↓                            ↓
  Tracking                   RAG + Code Graph
     ↓                            ↓
   Ready ──────────────────────→ PR
```

## Implementation Priority

1. **MCP Server** — expose RAG + Code Graph to GHCP/Claude Desktop
2. **Story Model** — refactor workflow → story, add issue link, worktree-per-story
3. **GitHub Issue Sync** — one-way import first, bidirectional later
4. **Extension Pivot** — story list as primary view, not workflow steps

## What We Keep

| Component | Reuse |
|-----------|-------|
| RAG + Code Graph | ✅ Core value — exposed via MCP |
| PostgreSQL persistence | ✅ Story tracking, conversation history |
| Worktree support | ✅ Parallel story isolation |
| VS Code extension | ✅ Refocused on story management |
| Indexing pipeline | ✅ Unchanged, serves MCP |
| Agent framework | ⚠️ Background tasks, automation |
| Tool execution | ⚠️ Exposed via MCP tools |

## What Changes

| Current | Future |
|---------|--------|
| Workflow steps are primary UI | Story list is primary UI |
| Execute step runs agent | GHCP runs agent with Aura context |
| Review step at end | Continuous in conversation |
| Plan generated by LLM | Issue body is the plan |
| Single workflow at a time | Multiple stories in parallel |

## What Retires (or Becomes Secondary)

- **Workflow step execution** — becomes "batch mode" for automation
- **Plan/Enrich/Review prompts** — repurpose for PR summary generation
- **Step-by-step UI** — replaced by story list + conversation history

## Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| GHCP doesn't support MCP yet | Medium | High | Works with Claude Desktop; GHCP support TBD |
| Merge conflicts in parallel work | Medium | Medium | Cross-story conflict detection |
| Bidirectional sync edge cases | High | Medium | Start one-way, defer full sync |
| Feature creep before shipping | High | High | Strict phasing, ship incrementally |
| Building features we won't use | Medium | High | Dogfood immediately |

## Monetization Implications

| Tier | LLM Providers | Features |
|------|---------------|----------|
| **Free/OSS** | Ollama, Azure OpenAI (BYOK) | All features |
| **Paid** | + Anthropic (Opus/Sonnet) | Managed API access |

All session infrastructure features are free. Paid tier is purely about LLM provider access (Anthropic costs real money).

## Consequences

### Positive

1. **Stop fighting GHCP** — extend instead of replace
2. **Leverage existing investment** — RAG, Code Graph, worktrees all remain valuable
3. **Clearer differentiation** — session infrastructure vs. agent execution
4. **Simpler agent story** — let GHCP handle the hard LLM orchestration
5. **Parallel development enabled** — the original vision, finally achievable

### Negative

1. **Dependency on GHCP/MCP** — blocked if Microsoft doesn't support custom MCP
2. **Structured workflows diminished** — sunk cost, but not working anyway
3. **Pivot messaging** — if anyone was using structured mode (unlikely)

### Neutral

1. **Extension refactor required** — story-centric vs. workflow-centric
2. **Data model evolution** — workflow → story migration

## Validation Questions

Before full commitment, validate:

1. **Does GHCP support custom MCP servers today?** — Critical path blocker
2. **Does Claude Desktop + Aura MCP work well?** — Proof of concept
3. **Is the story model actually simpler?** — Don't add complexity
4. **Will we use this ourselves?** — Dogfood immediately

## Key Design Decisions (from 2026-01-13 discussion)

### 1. VS Code Has Native MCP Support

**Discovery:** VS Code now has `vscode.lm.registerMcpServerDefinitionProvider` API. This means:
- No separate `Aura.Mcp` project needed
- Extension registers Aura.Api as MCP server automatically
- HTTP transport works (point to running API)
- No user configuration required

**Impact:** MCP implementation is dramatically simpler (~2 days vs. weeks).

### 2. Workflow IS Story

**Decision:** Don't create a new Story entity. Extend existing Workflow with:
- `IssueUrl`, `IssueNumber`, `IssueOwner`, `IssueRepo` — issue linking
- `Mode` enum — `Structured` (current) vs `Conversational` (new)

**Rename:** User will rename `Workflow` → `Story` via compiler refactoring when ready.

**Rationale:** Avoid migration complexity. Structured workflows are just stories with steps.

### 3. Append-Only Issue Sync

**Decision:** No bidirectional sync with conflict detection. Too complex, unnecessary.

**Sync model:**
- **Import:** Fetch issue title/body → create Story (on demand)
- **Refresh:** Re-fetch issue → overwrite local (user-initiated)
- **Update:** Append timestamped comment to issue
- **Close:** Close issue when Story complete

**Rationale:** There's no merge problem. We just add comments with timestamps. The issue is the source of truth for requirements; the Story is the source of truth for work state.

### 4. Conversational Mode = GHCP + Aura Context

**What Aura does:**
- Creates worktree for story
- Exposes context via MCP (RAG, Code Graph)
- Tracks story state

**What Aura doesn't do:**
- Run the agent
- Manage the conversation
- Execute tools

**Rationale:** Don't fight GHCP. Extend it.

### 5. Structured Mode Remains Available

**Decision:** Keep structured workflows as an option, not the default.

**Use cases for structured:**
- Batch automation
- Well-defined tasks with known patterns
- CI/CD integration

**Default:** Conversational mode for interactive development.

## References

- [ADR-009: Lessons from Previous Attempts](009-lessons-from-previous-attempts.md) — Why top-down failed before
- [MCP Server Spec](../features/upcoming/mcp-server.md) — Simplified design using VS Code native API
- [Story Model Spec](../features/upcoming/story-model.md) — GitHub Issue integration
- [MCP Protocol](https://modelcontextprotocol.io/) — Anthropic's context protocol
- Discussion: 2026-01-13 design session on parallel story development
