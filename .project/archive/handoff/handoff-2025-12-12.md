# Handoff: Terminology Cleanup - RepositoryPath vs WorktreePath

**Date:** 2025-12-12
**Status:** Nearly complete, needs testing

## What Was Done

Renamed entity properties for clarity:

| Entity | Old Property | New Property | Purpose |
|--------|--------------|--------------|---------|
| `Conversation` | `WorkspacePath` | `RepositoryPath` | Where the RAG index lives |
| `CodeNode` | `WorkspacePath` | `RepositoryPath` | Where the code graph is indexed |
| `Workflow` | `WorkspacePath` | `WorktreePath` | Isolated worktree for workflow execution |
| `Workflow` | (new) | `RepositoryPath` | Where the index lives (git repo root) |

**Key Insight:** Workflows have TWO paths:
- `RepositoryPath` = The git repo root (e.g., `C:\work\brightsword`) - for RAG/graph queries
- `WorktreePath` = The isolated worktree (e.g., `C:\work\brightsword\.worktrees\workflow-xxx`) - for git operations

**AgentContext.WorkspacePath was kept unchanged** - it's where the agent works (could be either).

## Files Changed

### C# Backend (all complete)
- `src/Aura.Foundation/Data/Entities/Conversation.cs` - `RepositoryPath`
- `src/Aura.Foundation/Data/Entities/CodeNode.cs` - `RepositoryPath`
- `src/Aura.Module.Developer/Data/Entities/Workflow.cs` - `RepositoryPath` + `WorktreePath`
- `src/Aura.Foundation/Data/AuraDbContext.cs` - Column mappings updated
- `src/Aura.Module.Developer/Data/DeveloperDbContext.cs` - Column mappings updated
- `src/Aura.Foundation/Rag/ICodeGraphService.cs` - All params → `repositoryPath`
- `src/Aura.Foundation/Rag/CodeGraphService.cs` - Implementation updated
- `src/Aura.Foundation/Rag/Indexing/ICodeGraphIndexer.cs` - Params updated
- `src/Aura.Foundation/Rag/Indexing/CodeGraphIndexer.cs` - ~40 occurrences updated
- `src/Aura.Module.Developer/Services/WorkflowService.cs` - Uses `workflow.WorktreePath`
- `src/Aura.Foundation/Conversations/ConversationService.cs` - Uses `RepositoryPath`
- `src/Aura.Api/Program.cs` - API endpoints updated, `CreateWorkflowRequest` uses `RepositoryPath`

### TypeScript Extension (all complete)
- `extension/src/services/auraApiService.ts` - `Workflow` interface uses `worktreePath`
- `extension/src/providers/workflowPanelProvider.ts` - All `workflow.workspacePath` → `workflow.worktreePath`

### Database
- Created `scripts/recreate-foundation-schema.sql` - Foundation tables with `repository_path`
- Created `scripts/recreate-developer-schema.sql` - Developer tables with `repository_path` + `worktree_path`
- Ran both scripts against the database
- Created fresh EF migration: `20251212023219_InitialCreate`
- Marked migration as applied in `__EFMigrationsHistory`

### Configuration
- Added `ConfigureWarnings` to suppress `PendingModelChangesWarning` in `Program.cs`

## What Needs Testing

1. **Create a workflow via extension** at `C:\work\brightsword`
   - Verify `repositoryPath` is populated in database
   - Verify `worktreePath` is populated after worktree creation

2. **Index the repository**
   - Already started: Job ID `eaf51aef-3907-4351-8de0-15b4cfae894a`
   - Check status: `GET http://localhost:5300/api/index/jobs/{jobId}`

3. **Run a workflow through analyze/plan/execute**
   - Verify RAG queries use `repositoryPath`
   - Verify git operations use `worktreePath`

## Open Items

1. **Code Graph Status Panel** - Feature filed at `.project/features/upcoming/code-graph-status-panel.md`
   - Add Code Graph stats to VS Code extension System Status panel

## Commands to Resume

```powershell
# Check indexing status
Invoke-RestMethod -Uri "http://localhost:5300/api/index/jobs/eaf51aef-3907-4351-8de0-15b4cfae894a"

# Create workflow with correct field
$body = @{title = "Test"; description = "Test"; repositoryPath = "C:\work\brightsword"} | ConvertTo-Json
Invoke-RestMethod -Uri "http://localhost:5300/api/developer/workflows" -Method POST -ContentType "application/json" -Body $body

# Check workflow in database
echo "SELECT id, title, repository_path, worktree_path FROM workflows ORDER BY created_at DESC LIMIT 1;" | podman exec -i -e PGPASSWORD="N1~gAx~82Jbnur8AFq6ddE" aura-postgres psql -U postgres -d auradb
```

## Build Status
- C# solution: ✅ Builds successfully
- Extension: ✅ Builds successfully (run `.\scripts\Build-Extension.ps1` if changed)
- API: Running (restart with `Start-Api` after code changes)
