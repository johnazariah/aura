# Phase 9: RAG Pipeline

**Duration:** 2-3 hours  
**Dependencies:** Phase 2 (LLM Providers), Phase 3 (Data Layer)  
**Output:** Local-first RAG with Ollama embeddings and pgvector storage
**Status:** COMPLETE

## Objective

Implement the local RAG (Retrieval-Augmented Generation) pipeline that allows agents to:
- Index content (code, documents, markdown, etc.)
- Query indexed content with semantic search
- Retrieve relevant context for agent prompts

**Privacy Promise:** All data stays local - embeddings generated by Ollama, stored in local PostgreSQL with pgvector.

## Tasks

### 9.1 Core Interfaces and Types - COMPLETE

Created foundational types for the RAG system:
- `src/Aura.Foundation/Rag/IRagService.cs` - Main service interface
- `src/Aura.Foundation/Rag/RagContent.cs` - Content to be indexed
- `src/Aura.Foundation/Rag/RagResult.cs` - Query results
- `src/Aura.Foundation/Rag/RagOptions.cs` - Configuration options
- `src/Aura.Foundation/Rag/RagContentType.cs` - Content type enum

### 9.2 Embedding Support in LLM Provider - COMPLETE

Added embedding generation to the LLM provider:
- `src/Aura.Foundation/Llm/IEmbeddingProvider.cs` - New interface for embeddings
- `src/Aura.Foundation/Llm/OllamaProvider.cs` - Implements both ILlmProvider and IEmbeddingProvider

### 9.3 Database Schema with pgvector - COMPLETE

Added vector storage to PostgreSQL:
- `src/Aura.Foundation/Data/Entities/RagChunk.cs` - EF Core entity with Vector column
- Updated `AuraDbContext.cs` with RagChunks DbSet and pgvector extension

### 9.4 Text Chunker - COMPLETE

Created text chunking logic:
- `src/Aura.Foundation/Rag/TextChunker.cs` - Splits content preserving semantic boundaries

### 9.5 RAG Service Implementation - COMPLETE

Implemented main RAG service:
- `src/Aura.Foundation/Rag/RagService.cs` - Full implementation with indexing, querying, stats

### 9.6 DI Registration - COMPLETE

Wired up RAG services in dependency injection:
- Updated `ServiceCollectionExtensions.cs` with AddRagServices()

### 9.7 API Endpoints - COMPLETE

Added RAG endpoints to API:
- `POST /api/rag/index` - Index single content
- `POST /api/rag/index/directory` - Index entire directory
- `POST /api/rag/query` - Query indexed content
- `DELETE /api/rag/{contentId}` - Remove indexed content
- `DELETE /api/rag` - Clear entire index
- `GET /api/rag/stats` - Get index statistics
- `GET /health/rag` - RAG health check

### 9.8 Health Check and Tests - PARTIAL

Completed:
- Updated `/health/rag` endpoint with real health check
- Foundation unit tests all pass (75 tests)

Future work (deferred):
- Add dedicated unit tests for TextChunker
- Add dedicated unit tests for RagService
- Add integration tests for full RAG pipeline

## Build Status

- Solution builds successfully (0 errors)
- 75 Foundation unit tests pass
- 2 integration tests fail (pre-existing, require running infrastructure)

## Configuration

```json
{
  "Aura": {
    "Rag": {
      "EmbeddingModel": "nomic-embed-text",
      "ChunkSize": 2000,
      "ChunkOverlap": 200,
      "DefaultTopK": 5,
      "MinRelevanceScore": 0.3
    }
  }
}
```

## Dependencies Installed

**NuGet Packages:**
- `Pgvector.EntityFrameworkCore` v0.2.2 - pgvector support for EF Core

**Ollama Model Required:**
- `nomic-embed-text` - Fast embeddings (768 dimensions)

To pull the model: `ollama pull nomic-embed-text`

## Files Created/Modified

### New Files
- `src/Aura.Foundation/Rag/IRagService.cs`
- `src/Aura.Foundation/Rag/RagContent.cs`
- `src/Aura.Foundation/Rag/RagContentType.cs`
- `src/Aura.Foundation/Rag/RagOptions.cs`
- `src/Aura.Foundation/Rag/RagResult.cs`
- `src/Aura.Foundation/Rag/RagService.cs`
- `src/Aura.Foundation/Rag/TextChunker.cs`
- `src/Aura.Foundation/Data/Entities/RagChunk.cs`
- `src/Aura.Foundation/Llm/IEmbeddingProvider.cs`

### Modified Files
- `src/Aura.Foundation/Llm/OllamaProvider.cs` - Added IEmbeddingProvider implementation
- `src/Aura.Foundation/Data/AuraDbContext.cs` - Added RagChunks DbSet and pgvector
- `src/Aura.Foundation/ServiceCollectionExtensions.cs` - Added AddRagServices()
- `src/Aura.Foundation/Aura.Foundation.csproj` - Added Pgvector.EntityFrameworkCore package
- `src/Aura.Api/Program.cs` - Added RAG API endpoints
